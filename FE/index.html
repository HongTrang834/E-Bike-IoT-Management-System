<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Bike Smart Management Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        #map {
            height: 600px;
            width: 100%;
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
        }

        .status-online {
            color: #10b981;
        }

        .status-offline {
            color: #ef4444;
        }

        .custom-marker {
            transition: all 0.5s ease-in-out;
        }
    </style>
</head>

<body class="bg-gray-900 text-white font-sans">
    <div class="container mx-auto p-4 lg:p-8">
        <header class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
            <div>
                <h1 class="text-3xl font-extrabold text-blue-500 tracking-tight">E-BIKE SHARING SYSTEM</h1>
                <p class="text-gray-400">H·ªá th·ªëng qu·∫£n l√Ω v√† ƒëi·ªÅu h√†nh th·ªùi gian th·ª±c</p>
            </div>
            <div id="conn-status" class="bg-red-600 px-6 py-2 rounded-full text-sm font-bold shadow-lg animate-pulse">
                ƒêANG K·∫æT N·ªêI...
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
            <div class="lg:col-span-1 space-y-6">
                <div class="bg-gray-800 p-6 rounded-xl border border-gray-700 shadow-2xl">
                    <h2 class="text-xl font-bold mb-4 border-b border-gray-700 pb-2 text-blue-400">Th√¥ng tin xe</h2>
                    <div id="vehicle-info" class="space-y-3">
                        <p class="text-gray-400 italic">Vui l√≤ng k·∫øt n·ªëi ƒë·ªÉ xem d·ªØ li·ªáu...</p>
                    </div>

                    <div class="mt-8 pt-6 border-t border-gray-700">
                        <h3 class="text-sm font-bold text-gray-500 uppercase mb-4">ƒêi·ªÅu khi·ªÉn t·ª´ xa</h3>
                        <div class="grid grid-cols-2 gap-3">
                            <button onclick="sendCMD(1, 1)"
                                class="bg-green-600 hover:bg-green-700 p-3 rounded-lg font-bold transition">KH√ìA
                                XE</button>
                            <button onclick="sendCMD(1, 0)"
                                class="bg-blue-600 hover:bg-blue-700 p-3 rounded-lg font-bold transition">M·ªû
                                KH√ìA</button>
                            <button onclick="sendCMD(3, 1)"
                                class="bg-yellow-600 hover:bg-yellow-700 p-3 rounded-lg font-bold transition col-span-2">T√åM
                                XE (C√íI)</button>
                        </div>
                    </div>
                </div>

                <div class="bg-black bg-opacity-50 p-4 rounded-xl h-40 overflow-y-auto text-xs font-mono border border-gray-800"
                    id="logs">
                    <div>[SYSTEM] Kh·ªüi t·∫°o Dashboard...</div>
                </div>
            </div>

            <div class="lg:col-span-3 relative">
                <div id="map"></div>
            </div>
        </div>
    </div>

    <script>
         // --- 1. C·∫§U H√åNH ---
        const TOKEN = "access_v1_1768530446399";
        const WS_URL = 'ws://localhost:3000/api/user/ws';

        // --- 2. KH·ªûI T·∫†O B·∫¢N ƒê·ªí ---
        const map = L.map('map').setView([10.762622, 106.660172], 15);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OpenStreetMap'
        }).addTo(map);

        const bikeIcon = L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/9214/9214572.png', // Ho·∫∑c link file c·ªßa b·∫°n
            iconSize: [45, 45],
            iconAnchor: [22, 22]
        });

        let markers = {};
        let vehicleData = { telemetry: {}, status: {} };

        // --- 3. K·∫æT N·ªêI WEBSOCKET ---
        const socket = new WebSocket(WS_URL, [TOKEN]);

        socket.onopen = () => {
            log("K·∫øt n·ªëi Server th√†nh c√¥ng", "success");
            const statusEl = document.getElementById('conn-status');
            statusEl.innerText = "H·ªÜ TH·ªêNG TR·ª∞C TUY·∫æN";
            statusEl.className = "bg-green-600 px-6 py-2 rounded-full text-sm font-bold shadow-lg";
        };

        socket.onmessage = (event) => {
            const msg = JSON.parse(event.data);
            console.log("Nh·∫≠n t·ª´ server:", msg);

            // A. PH·∫¢N H·ªíI HEARTBEAT 
            if (msg.type === 'heartbeat' && msg.data === 'ping') {
                const pongFrame = JSON.stringify({ type: "heartbeat", data: "pong" });
                socket.send(pongFrame);
                console.log("G·ª≠i ƒë·∫øn server:", pongFrame);
                return;
            }

            // B. NH·∫¨N D·ªÆ LI·ªÜU T·ª™ SERVER
            switch (msg.type) {
                case 'token':
                    if (msg.data === 'OK') log("ƒê√£ x√°c th·ª±c quy·ªÅn ƒëi·ªÅu khi·ªÉn", "success");
                    break;

                case 'telemetry':
                    handleTelemetry(msg.data);
                    break;

                case 'status':
                    handleStatus(msg.data);
                    break;
            }
        };

        // --- 4. X·ª¨ L√ù LOGIC ---
        function handleTelemetry(data) {
            const { lat, lon, speed, vehicle_id } = data;
            vehicleData.telemetry = data;

            // C·∫≠p nh·∫≠t Marker
            if (lat && lon) {
                if (markers[vehicle_id]) {
                    markers[vehicle_id].setLatLng([lat, lon]);
                } else {
                    markers[vehicle_id] = L.marker([lat, lon], { icon: bikeIcon }).addTo(map).bindPopup(`Xe: ${vehicle_id}`);
                }
                map.panTo([lat, lon]); // T·ª± ƒë·ªông ƒëi theo xe
            }
            renderInfo();
        }

        function handleStatus(data) {
            vehicleData.status = data;
            log(`C·∫≠p nh·∫≠t tr·∫°ng th√°i xe: Pin ${data.battery}%`, "info");
            renderInfo();
        }

        function renderInfo() {
            const infoBox = document.getElementById('vehicle-info');
            const t = vehicleData.telemetry;
            const s = vehicleData.status;

            infoBox.innerHTML = `
                <div class="flex justify-between"><span>ID Xe:</span> <b class="text-blue-400">${t.vehicle_id || '---'}</b></div>
                <div class="flex justify-between"><span>V·∫≠n t·ªëc:</span> <b class="text-white">${t.speed || 0} km/h</b></div>
                <div class="flex justify-between"><span>Pin:</span> <b class="${s.battery < 20 ? 'text-red-500' : 'text-green-400'}">${s.battery || 0}%</b></div>
                <div class="flex justify-between"><span>Tr·∫°ng th√°i:</span> <b>${s.lock_state == 1 ? 'üîí ƒê√£ kh√≥a' : 'üîì ƒêang m·ªü'}</b></div>
            `;
        }

        // --- 5. G·ª¨I L·ªÜNH ƒêI·ªÄU KHI·ªÇN (CMD) ---
        function sendCMD(type, value) {
            if (socket.readyState !== WebSocket.OPEN) return alert("M·∫•t k·∫øt n·ªëi server!");

            const payload = { type, value };
            socket.send(JSON.stringify(payload));
            log(`G·ª≠i l·ªánh CMD: Type ${type}, Value ${value}`, "warning");
        }

        function log(text, type) {
            const logBox = document.getElementById('logs');
            const color = type === 'success' ? 'text-green-400' : type === 'warning' ? 'text-yellow-400' : 'text-blue-300';
            logBox.innerHTML += `<div class="${color}">[${new Date().toLocaleTimeString()}] ${text}</div>`;
            logBox.scrollTop = logBox.scrollHeight;
        }

        socket.onclose = () => {
            document.getElementById('conn-status').innerText = "M·∫§T K·∫æT N·ªêI";
            document.getElementById('conn-status').className = "bg-red-600 px-6 py-2 rounded-full text-sm font-bold shadow-lg";
            log("C·∫£nh b√°o: ƒê√£ ng·∫Øt k·∫øt n·ªëi v·ªõi Server!", "error");
        }; 





    </script>
</body>

</html>